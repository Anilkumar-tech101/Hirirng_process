name: Deploy to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # 1️⃣ Checkout the repository
    - name: Checkout repository
      uses: actions/checkout@v3

    # 2️⃣ Setup SSH key
    - name: Setup SSH key
      run: |
        echo "${{ secrets.EC2_KEY }}" | base64 --decode > mykey.pem
        chmod 400 mykey.pem

    # 3️⃣ Ensure SSH directory exists and add EC2 host to known_hosts
    - name: Add EC2 to known_hosts
      run: |
        mkdir -p $HOME/.ssh
        chmod 700 $HOME/.ssh
        ssh-keyscan -H ${{ secrets.EC2_HOST }} >> $HOME/.ssh/known_hosts
        chmod 644 $HOME/.ssh/known_hosts

    # 4️⃣ Deploy to EC2
    - name: Add EC2 to known_hosts
  run: |
    mkdir -p ~/.ssh
    chmod 700 ~/.ssh
    touch ~/.ssh/known_hosts
    chmod 644 ~/.ssh/known_hosts
    for i in {1..5}; do
      ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts && break || sleep 5
    done
